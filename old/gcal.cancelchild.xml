<?php

header("content-type: application/vnd.xml");
print ("<?xml version=\"1.0\" encoding=\"UTF-8\"?>");

?>

<Module>
<ModulePrefs 
      title_url="http://www.google.com/calendar/render" 
      title="Google Calendar"
      description="Displays your google calendar on your google homepage"
      author="Chris McKeever" 
      author_location="Chicago" 
      author_email="cgmckeever@r2unit.com" 
      scrolling="true"
      render_inline="required"
      screenshot="http://r2unit.com/gmodule/image/gcalmodule.jpg"
      thumbnail="http://r2unit.com/gmodule/image/Tgcalmodule.jpg"
 />
       

<UserPref name="EVENTS_TO_SHOW"
        display_name="Display Events"
        datatype="enum"
        default_value="5">
    <EnumValue value="1" display_value="1"/>
    <EnumValue value="3" display_value="3"/>
    <EnumValue value="5" display_value="5"/>
    <EnumValue value="7" display_value="7"/>
    <EnumValue value="10" display_value="10"/>
    <EnumValue value="15" display_value="15"/>
    <EnumValue value="20" display_value="20"/>
    <EnumValue value="30" display_value="30"/>
    <EnumValue value="50" display_value="50"/>
    <EnumValue value="100" display_value="a lot"/>
    <EnumValue value="200" display_value="way too many"/>
</UserPref>
<UserPref name="DAYFORWARD"
        display_name="Days Ahead"
        datatype="enum"
        default_value="90">
    <EnumValue value="15" display_value="15"/>
    <EnumValue value="30" display_value="30"/>
    <EnumValue value="60" display_value="60"/>
    <EnumValue value="90" display_value="90"/>
    <EnumValue value="120" display_value="120"/>
    <EnumValue value="150" display_value="150"/>
    <EnumValue value="300" display_value="300"/>
    <EnumValue value="365" display_value="365"/>
    <EnumValue value="400" display_value="400"/>
</UserPref>
<UserPref name="DISPLAY_HEIGHT"
        display_name="Display Height"
        datatype="enum"
        default_value="150">
    <EnumValue value="75" display_value="Tiny"/>
    <EnumValue value="150" display_value="Standard"/>
    <EnumValue value="250" display_value="Slightly Bigger"/>
    <EnumValue value="400" display_value="Bigger"/>
    <EnumValue value="600" display_value="Even Bigger"/>
    <EnumValue value="800" display_value="Biggest"/>
    <EnumValue value="-1" display_value="Just Grow"/>
</UserPref>
<UserPref name="DISPLAY_FONT"
        display_name="Display Font"
        datatype="enum"
        default_value="8">
    <EnumValue value="8" display_value="Small"/>
    <EnumValue value="10" display_value="Medium"/>
    <EnumValue value="12" display_value="Large"/>
    <EnumValue value="14" display_value="Super Size"/>
</UserPref>
<UserPref name="HIGHLIGHT_TODAY" display_name="Highlight Today's"  datatype="bool" default_value="true" />
<UserPref name="DDAY_OF_WEEK" display_name="Display Day"  datatype="bool" default_value="true" />
<UserPref name="DMONTH" display_name="Display Month"  datatype="bool" default_value="true" />
<UserPref name="DDATE" display_name="Display Date"  datatype="bool" default_value="true" />
<UserPref name="DYEAR" display_name="Display Year"  datatype="bool" default_value="true" />
<UserPref name="DTIME" display_name="Display Time"  datatype="bool" default_value="true" />
<UserPref name="DSINGLE" display_name="Single Line Format"  datatype="bool" default_value="false" />
<UserPref name="DLOCATION" display_name="Display Location"  datatype="bool" default_value="true" />
<UserPref name="GCAL_XML_FEED" display_name="Feed URL" />

    
<Content type="html">
<![CDATA[

<style>
.gcalItem__MODULE_ID__ {color: #000000; font-size: 8pt;}
.HgcalItem__MODULE_ID__ {color: #000000; font-size: 8pt;background-color:#FFFFCC}
.GgcalItem__MODULE_ID__ {color: #000000; font-size: 8pt;background-color:#CCFF66}
</style>

<script src="http://mailqueue.googlepages.com/tinyxmldom.js"></script>

<script>
  // Get user preferences
  var prefs = new _IG_Prefs(__MODULE_ID__);
  // delays trigger till content is loaded
  _IG_RegisterOnloadHandler(initialize__MODULE_ID__);

/*

Google Module for Google Calendar
Chris McKeever - 2006 cgmckeever@r2unit.com

based of the original work Paul Russell.
http://russelldad.googlepages.com/googlecalendar_v001.xml


*/


var XmlErrorOccurred__MODULE_ID__ = false;

function initialize__MODULE_ID__(){

  // define global
  feed_url__MODULE_ID__ = prefs.getString('GCAL_XML_FEED');
  dayForward__MODULE_ID__ = prefs.getString('DAYFORWARD');

  IE__MODULE_ID__ = 0;
  if (navigator.appName == "Microsoft Internet Explorer") IE__MODULE_ID__ = 1;

  // Month array
  monthA__MODULE_ID__ = new Array;
  monthA__MODULE_ID__[1] = 'January';
  monthA__MODULE_ID__[2] = 'February';
  monthA__MODULE_ID__[3] = 'March';
  monthA__MODULE_ID__[4] = 'April';
  monthA__MODULE_ID__[5] = 'May';
  monthA__MODULE_ID__[6] = 'June';
  monthA__MODULE_ID__[7] = 'July';
  monthA__MODULE_ID__[8] = 'August';
  monthA__MODULE_ID__[9] = 'September';
  monthA__MODULE_ID__[10] = 'October';
  monthA__MODULE_ID__[11] = 'Novemeber';
  monthA__MODULE_ID__[12] = 'December';

  // Day array
  dayA__MODULE_ID__ = new Array;
  dayA__MODULE_ID__['Sun'] = 'Sunday';
  dayA__MODULE_ID__['Mon'] = 'Monday';
  dayA__MODULE_ID__['Tue'] = 'Tuesday';
  dayA__MODULE_ID__['Wed'] = 'Wednesday';
  dayA__MODULE_ID__['Thu'] = 'Thursday';
  dayA__MODULE_ID__['Fri'] = 'Friday';
  dayA__MODULE_ID__['Sat'] = 'Saturday';
 
  // object shorthand
  newNode__MODULE_ID__ = getObjMethodClosure__MODULE_ID__(document, "createElement");

  // current date info
  nowParse__MODULE_ID__ = dateParse__MODULE_ID__(new Date());
  nowYear__MODULE_ID__ = nowParse__MODULE_ID__[4]; 
  now__MODULE_ID__ = new Date(nowParse__MODULE_ID__[2] + " " + nowParse__MODULE_ID__[3] + " " + nowParse__MODULE_ID__[4]);
  nowTS__MODULE_ID__ = now__MODULE_ID__.getTime();

  start_maxTS__MODULE_ID__ = parseInt(nowTS__MODULE_ID__) + (1000 * 60 * 60 * 24) * dayForward__MODULE_ID__;
  start_max__MODULE_ID__ = new Date(start_maxTS__MODULE_ID__);
  start_maxMonth__MODULE_ID__ = start_max__MODULE_ID__.getMonth() + 1;
  start_maxMonth__MODULE_ID__ = start_maxMonth__MODULE_ID__.toString();
  if (start_maxMonth__MODULE_ID__.length == 1) start_maxMonth__MODULE_ID__ = "0" + start_maxMonth__MODULE_ID__;
  start_max__MODULE_ID__ = dateParse__MODULE_ID__(start_max__MODULE_ID__);
  if (start_max__MODULE_ID__[3].length == 1) start_max__MODULE_ID__[3] = "0" + start_max__MODULE_ID__[3];
  start_max__MODULE_ID__ = start_max__MODULE_ID__[4] + "-" + start_maxMonth__MODULE_ID__ + "-" + start_max__MODULE_ID__[3]


  backdateTS__MODULE_ID__ = nowTS__MODULE_ID__ - (45 * 24 * 60 * 60 * 1000) // look back days
  backdate__MODULE_ID__ = new Date(backdateTS__MODULE_ID__);
  backdateMonth__MODULE_ID__ = backdate__MODULE_ID__.getMonth() + 1;
  backdateMonth__MODULE_ID__ = backdateMonth__MODULE_ID__.toString();
  if (backdateMonth__MODULE_ID__.length == 1) backdateMonth__MODULE_ID__ = "0" + backdateMonth__MODULE_ID__;
  backdateParse__MODULE_ID__ = dateParse__MODULE_ID__(backdate__MODULE_ID__);
  if (backdateParse__MODULE_ID__[3].length == 1) backdateParse__MODULE_ID__[3] = "0" + backdateParse__MODULE_ID__[3];  
  start_min__MODULE_ID__ = backdateParse__MODULE_ID__[4] + "-" + backdateMonth__MODULE_ID__ + "-" + backdateParse__MODULE_ID__[3];

  deflen__MODULE_ID__ = 25; // default length of text units

  // DAY reverse Lookup Array
  revDay__MODULE_ID__ = new Array;
  revDay__MODULE_ID__['SU'] = 0;
  revDay__MODULE_ID__['MO'] = 1;
  revDay__MODULE_ID__['TU'] = 2;
  revDay__MODULE_ID__['WE'] = 3;
  revDay__MODULE_ID__['TH'] = 4;
  revDay__MODULE_ID__['FR'] = 5;
  revDay__MODULE_ID__['SA'] = 6;

  // Array of events
  EventList__MODULE_ID__ = new Array();
  
  // end global declarations 

  if( feed_url__MODULE_ID__ == '' ){
    _gel('start_content__MODULE_ID__').style.display = '';
    return;
  }else{
    var now = dayA__MODULE_ID__[nowParse__MODULE_ID__[1]] + " " + nowParse__MODULE_ID__[2] + " " + nowParse__MODULE_ID__[3] + ", " + nowParse__MODULE_ID__[4];
    var dDIV = newNode__MODULE_ID__('div');
    dDIV.innerHTML = "<CENTER>" + now + "</CENTER>";
    _gel('date_content__MODULE_ID__').appendChild(dDIV);
 
    _gel('status_content__MODULE_ID__').style.display = '';

    feed_change__MODULE_ID__ = false;
    if (feed_url__MODULE_ID__.match(/.*basic$/)){
      // first try FULL
      feed_change__MODULE_ID__ = true;
      feed_url__MODULE_ID__ = feed_url__MODULE_ID__.replace(/basic$/,'full');
    }
    var feed_url = feed_url__MODULE_ID__ + "?start-max=" + start_max__MODULE_ID__ + "&start-min=" +  start_min__MODULE_ID__;
    _IG_FetchContent(feed_url, parseCalendarXML__MODULE_ID__ );

  }
}

function parseCalendarXML__MODULE_ID__(feedXML){
  var responseDOM = new XMLDoc(feedXML, function(error){if(XmlErrorOccurred__MODULE_ID__ == false) XmlErrorOccurred__MODULE_ID__ = true;});
    
  if ( responseDOM == null || responseDOM.docNode == null){
    
    if (feed_change__MODULE_ID__ == true){
      // feed was changed try the input one
      feed_change__MODULE_ID__ = false;
      feed_url__MODULE_ID__ = feed_url__MODULE_ID__.replace(/full$/,'basic');
      var feed_url = feed_url__MODULE_ID__ + "?start-max=" + start_max__MODULE_ID__ + "&start-min=" +  start_min__MODULE_ID__;
      // resend it
      _IG_FetchContent(feed_url, parseCalendarXML__MODULE_ID__ );
      return; 
    }

    var spHTML = _gel('start_content__MODULE_ID__').innerHTML;
    spHTML = "<FONT style='color:red;font-size:.8em;'>The response from Google contained invalid XML.</FONT><BR><BR>" + spHTML;
    _gel('start_content__MODULE_ID__').innerHTML = spHTML;
    _gel('status_content__MODULE_ID__').style.display = 'none';
    _gel('start_content__MODULE_ID__').style.display = '';
    return;
  } else feed_change__MODULE_ID__ = false;
  
  var disHeight = prefs.getString('DISPLAY_HEIGHT');
  if (parseInt(disHeight) != -1) _gel('calendar_content__MODULE_ID__').style.height = disHeight + "px";

  var eventNodes = responseDOM.docNode.getElements("entry");
  var summaryNode;
  var recurrenceNode;
  var whenNodes;
  var originalID;
  var statusNode;
  var evChild;
  var aCancelled = new Array;
  var aEvent = new Array;
  
  var evId;
  var evTitle;
  var evStartTS;
  var evEndTs;
  var evURL;
  var evLocation;
  var evRepeatTS;
  var evRepeatInt;
  var evRepeatType;
  var evRepeatByDay;

  var idRE = /[^\/]*$/;

  for (var eventNode = 0; eventNode < eventNodes.length; ++eventNode){
    evId = idRE.exec(eventNodes[eventNode].getElements("id")[0].getText());
    evTitle = shrink__MODULE_ID__(eventNodes[eventNode].getElements("title")[0].getText(),deflen__MODULE_ID__,"...");
    evURL = eventNodes[eventNode].getElements("link")[0].getAttribute('href');

    summaryNode = eventNodes[eventNode].getElements('summary')[0];
    recurrenceNode = eventNodes[eventNode].getElements('gd:recurrence')[0];  
    whenNodes = eventNodes[eventNode].getElements("gd:when"); 
 
    evChild = false;
    originalID = eventNodes[eventNode].getElements("gd:originalEvent");
    if (originalID[0]){
      evChild = true;
      originalID = originalID[0].getAttribute('id');
    }else{
      originalID = evId;
    }

    statusNodes = eventNodes[eventNode].getElements("gd:eventStatus");

    evCancelled = false;
    for (var statusI = 0; statusI < statusNodes.length; ++statusI){
      if(statusNodes[statusI].getAttribute('value').match(/.canceled/)) aCancelled[originalID] = true;
    }

    evRepeatTS = "";
    evRepeatInt = "";
    evRepeatType = "";
    evRepeatByDay = "";

    if (whenNodes.length > 0){  
      // normal event node
      aEvent = new Array;
      evLocation = shrink__MODULE_ID__(eventNodes[eventNode].getElements('gd:where')[0].getAttribute('valueString'),deflen__MODULE_ID__,"...");

      for (var whenNode = 0; whenNode < whenNodes.length; ++whenNode){
        aEvent[whenNode] = new Array;
        aEvent[whenNode]['evStartTS'] = TSfromISO__MODULE_ID__(whenNodes[whenNode].getAttribute('startTime'),0);
        aEvent[whenNode]['evEndTS'] = TSfromISO__MODULE_ID__(whenNodes[whenNode].getAttribute('endTime'),0);

        var duration = aEvent[whenNode]['evEndTS'] - aEvent[whenNode]['evStartTS'];
        if (duration == 86400000){
          // all day event 
          aEvent[whenNode]['evEndTS'] = aEvent[whenNode]['evStartTS'];
        }

      }

    } else if (recurrenceNode){ 
      var sdRRE = /:([^\s]+)/; // recurring event date time
      var dsRRE = /DURATION:PT([0-9]+)/; // duration in seconds
      var rRRE = /RRULE:[^\s]+/; // recurrence rule
      var untilRRE = /UNTIL=([0-9]{4}[0-9]{2}[0-9]{2})/;
      var intRRE = /INTERVAL=([^;]+)/;
      var freqRRE = /FREQ=([^;]+)/;
      var dayRRE = /BYDAY=([^;]+)/;
      var recParam; // recurrence parameters
      evLocation = shrink__MODULE_ID__(eventNodes[eventNode].getElements('gd:where')[0].getAttribute('valueString'),deflen__MODULE_ID__,"...");
      recParam = recurrenceNode.getText();

      evStartTS = sdRRE.exec(recParam);
      // currently assumes repeating events are defined in LOCAL TZ
      evStartTS = TSfromLocal__MODULE_ID__(evStartTS[1]);
      
      var duration = dsRRE.exec(recParam); // duration in seconds
      if (parseInt(duration[1]) == 86400){ // all day event
        var evEndTS = evStartTS
      } else {
        var evEndTS = parseInt(evStartTS) + parseInt(duration[1]) * 1000; // end date
      }

      // parse recurrence rules
      var rule = rRRE.exec(recParam);

      evRepeatType = freqRRE.exec(rule);
      if (evRepeatType){
        // type was null - can't determine recurrence elsewise
        evRepeatType = evRepeatType[1];

        var byday = dayRRE.exec(rule); 
	if (byday && evRepeatType == 'WEEKLY') {
          evRepeatByDay = new Array;
          for (var iDay = 0; iDay < 7; ++iDay){evRepeatByDay[iDay] = 0;}
	  byday = byday[1].split(",");
          for (iDay = 0; iDay < byday.length; ++iDay){evRepeatByDay[revDay__MODULE_ID__[byday[iDay]]] = 1;}
	}else if(byday && evRepeatType == 'MONTHLY'){
          evRepeatByDay = byday[1];    
	}

        evRepeatTS = untilRRE.exec(rule);
        if (evRepeatTS) {
          evRepeatTS = TSfromLocal__MODULE_ID__(evRepeatTS[1]);
          if (evRepeatTS > maxRepeatTS__MODULE_ID__) evRepeatTS = maxRepeatTS__MODULE_ID__;
        } else evRepeatTS = maxRepeatTS__MODULE_ID__;  // no ednd was set/found - default to max

        evRepeatInt = intRRE.exec(rule);
        evRepeatInt = (evRepeatInt) ? evRepeatInt[1] : "1";

      } else evRepeatType = "";

    }else if(summaryNode){ 
      var wSRE = /Where:\s+([^<]+)/; // RE for summary Location information
      evLocation = wSRE.exec(summaryNode.getText());
      if(evLocation) { 
        evLocation = shrink__MODULE_ID__(evLocation[1],deflen__MODULE_ID__,"...")
      } else evLocation = "";
      var sumText = summaryNode.getText();
      var startPrefix = 'When:';

      if (sumText.match(/First start:/)){
        // recurrence in summary
        var dSRE = /Duration:[\s]*(.*)/;
        startPrefix = 'First start:';
        evStartTS = TSfromString__MODULE_ID__(startPrefix,sumText,1);
        evStartTS = dateParse__MODULE_ID__(evStartTS);
        if(evStartTS[2].substring(0,1) == "0") evStartTS[2] = evStartTS[2].substring(1,2);
        evStartTS = new Date(monthA__MODULE_ID__[parseInt(evStartTS[2])] + " " + evStartTS[3] + " " + nowYear__MODULE_ID__ + " " + evStartTS[5] + ":" + evStartTS[7]).getTime(); 
        var duration = dSRE.exec(sumText); // duration in seconds
        if (parseInt(duration[1]) == 86400){ // all day event
          evEndTS = evStartTS;
        } else {
          evEndTS = parseInt(evStartTS) + parseInt(duration[1]) * 1000; // end date
        }
      } else {
        evStartTS = TSfromString__MODULE_ID__(startPrefix,sumText,0);
        evEndTS = TSfromString__MODULE_ID__("to",sumText,0);
	if (!evEndTS){
          // checks for DT sent as date time to time
          var tSRE = /to[\s]+([0-9]{2}:[0-9]{2})/;
          var t = tSRE.exec(sumText); 
          evEndTS = dateParse__MODULE_ID__(evStartTS); 
          evEndTS = new Date(evEndTS[2] + " " + evEndTS[3] + " " + evEndTS[4] + " " + t[1]).getTime();
        }
      }

    }else{
      // normal event node
      // should never get in here do to new date parsing
      evLocation = shrink__MODULE_ID__(eventNodes[eventNode].getElements('gd:where')[0].getAttribute('valueString'),deflen__MODULE_ID__,"...");
      evStartTS = TSfromISO__MODULE_ID__(eventNodes[eventNode].getElements("gd:when")[0].getAttribute('startTime'),0);
      evEndTS = TSfromISO__MODULE_ID__(eventNodes[eventNode].getElements("gd:when")[0].getAttribute('endTime'),0);
    }

    if(!evChild && !aCancelled[originalID]){ 
      if (aEvent.length == 0){
        if (new Date(evEndTS).getTime() != evEndTS) evEndTS = evStartTS;
        addEvent__MODULE_ID__(new CalendarEvent__MODULE_ID__(evId,evTitle,evStartTS,evEndTS,evURL,evLocation,evRepeatTS,evRepeatType,evRepeatInt,evRepeatByDay));  
      } else {
        // loop the when node results and add
        for (var aWheni = 0; aWheni < aEvent.length; aWheni++){ 
          if (new Date(aEvent[aWheni]['evEndTS']).getTime() != aEvent[aWheni]['evEndTS']) aEvent[aWheni]['evEndTS'] = aEvent[aWheni]['evstartTS'];
          addEvent__MODULE_ID__(new CalendarEvent__MODULE_ID__(evId,evTitle,aEvent[aWheni]['evStartTS'],aEvent[aWheni]['evEndTS'],evURL,evLocation,evRepeatTS,evRepeatType,evRepeatInt,evRepeatByDay));
        }
      }
    } 

  }   

  EventList__MODULE_ID__ = EventList__MODULE_ID__.sort(function(a,b){return cmp__MODULE_ID__(a.startTS,b.startTS);});
  renderCalendar__MODULE_ID__(EventList__MODULE_ID__); 

}


function CalendarEvent__MODULE_ID__(id,title,startTS,endTS,URL,location,repeatTS,repeatType,repeatInt,repeatByDay){
  this.id = id;
  this.title = title;
  this.URL = URL;
  this.location = location;
    
  this.startTS = startTS;
  this.endTS = endTS;
  this.duration = parseInt(endTS) - parseInt(startTS);
 
  this.repeatTS = repeatTS;  
  this.repeatType = repeatType;
  this.repeatInt = repeatInt;
  this.repeatByDay = repeatByDay;
}


function addEvent__MODULE_ID__(event){

  // add event if it is in the future
  if (event.endTS >= nowTS__MODULE_ID__) {
	EventList__MODULE_ID__.push(event);
  }

  if (event.repeatTS >= nowTS__MODULE_ID__){
    if (event.repeatType=='WEEKLY') {
      addRecurringWeeklyEvent__MODULE_ID__(event)
    } else if (event.repeatType=='MONTHLY') {
      addRecurringMonthlyEvent__MODULE_ID__(event);
    } else if (event.repeatType=='YEARLY') {
      addRecurringYearlyEvent__MODULE_ID__(event);
    }
  }
}


function addRecurringWeeklyEvent__MODULE_ID__(event){

  var repeatDay = new Array;
  var startTS; 
  var newDay;
  var dateParse;
  var offset;
  if (event.repeatByDay != ''){
    var dow = new Date(event.startTS).getDay(); 
    for (iday = 0; iday < event.repeatByDay.length; ++iday){
      if (event.repeatByDay[iday] == 1){
        var addDay = iday - parseInt(dow); 
        if (addDay <= 0) addDay = (7 + addDay) * parseInt(event.repeatInt);
        startTS = parseInt(event.startTS) + (parseInt(event.repeatInt) * addDay * 60 * 60 * 24 * 1000);
        offset = (new Date(event.startTS).getTimezoneOffset() - new Date(startTS).getTimezoneOffset()) * 1000 * 60;
        // this _should_ handle crossing the DST
        startTS = parseInt(startTS) - parseInt(offset);
        repeatDay.push(startTS);
      }
    }
  }else{
    startTS = parseInt(event.startTS) + (parseInt(event.repeatInt) * 7 * 60 * 60 * 24 * 1000);
    offset = (new Date(event.startTS).getTimezoneOffset() - new Date(startTS).getTimezoneOffset()) * 1000 * 60;
    // this _should_ handle crossing the DST
    startTS = parseInt(startTS) - parseInt(offset); 
    repeatDay.push(startTS);
  }

  for (var irepeat = 0; irepeat < repeatDay.length; ++irepeat){
    startTS = repeatDay[irepeat];
    var endTS = parseInt(startTS) + parseInt(event.duration);
    if (event.repeatTS >= startTS)
      addEvent__MODULE_ID__(new CalendarEvent__MODULE_ID__(event.id,event.title,startTS,endTS,event.URL,event.location,event.repeatTS,event.repeatType,event.repeatInt,""));   // if
  }
  
}

function addRecurringMonthlyEvent__MODULE_ID__(event){

  var repeatDay = new Array;
  var startTS;
  var newMonth;
  var dateParse;
  var offset;
  if (event.repeatByDay != ''){
	// how to hanlde first of tuesday of the month etc??
  }else{
    startTS = dateParse__MODULE_ID__(event.startTS);
    newMonth = new Date(event.startTS).getMonth() + parseInt(event.repeatInt) + 1;
    if (newMonth > 12) {
      newMonth = newMonth - 12; 
      startTS[4] = parseInt(startTS[4]) + 1;
    }
    startTS = new Date(monthA__MODULE_ID__[newMonth] + " " + startTS[3] + " " + startTS[4] + " " + startTS[5] + ":" + startTS[7]).getTime();
    offset = (new Date(event.startTS).getTimezoneOffset() - new Date(startTS).getTimezoneOffset()) * 1000 * 60;
    // this _should_ handle crossing the DST
    startTS = parseInt(startTS) - parseInt(offset);
    repeatDay.push(startTS);
  }

  for (var irepeat = 0; irepeat < repeatDay.length; ++irepeat){
    startTS = repeatDay[irepeat];
    var endTS = parseInt(startTS) + parseInt(event.duration);
    if (event.repeatTS >= startTS)
      addEvent__MODULE_ID__(new CalendarEvent__MODULE_ID__(event.id,event.title,startTS,endTS,event.URL,event.location,event.repeatTS,event.repeatType,event.repeatInt,""));   // if
  }

}

function addRecurringYearlyEvent__MODULE_ID__(event){ 
  var dateParse = dateParse__MODULE_ID__(event.startTS);
  var newYear = parseInt(dateParse[4]) + parseInt(event.repeatInt);
  var startTS = new Date(dateParse[2] + " " + dateParse[3] + " " + newYear + " " + dateParse[5] + ":" + dateParse[7]).getTime();
  var endTS = parseInt(startTS) + parseInt(event.duration);
  if (event.repeatTS >= startTS)
    addEvent__MODULE_ID__(new CalendarEvent__MODULE_ID__(event.id,event.title,startTS,endTS,event.URL,event.location,event.repeatTS,event.repeatType,event.repeatInt,""));
}

function renderCalendar__MODULE_ID__(eventA){
  var max_display = prefs.getString('EVENTS_TO_SHOW');
  var Uhighlight = prefs.getBool('HIGHLIGHT_TODAY');
  var displayFont = prefs.getString('DISPLAY_FONT'); 
  var Dmonth = prefs.getBool('DMONTH');
  var Ddate = prefs.getBool('DDATE');
  var Dday_of_week = prefs.getBool('DDAY_OF_WEEK');
  var Dyear = prefs.getBool('DYEAR');
  var Dtime = prefs.getBool('DTIME');
  var Dlocation = prefs.getBool('DLOCATION');
  var Dsingle = prefs.getBool('DSINGLE');

  var calDIV = _gel('calendar_content__MODULE_ID__');
  var evDIV;
  var evHTML = "";
  var event; var summary; var tT; var std; var etd;

  var now = nowParse__MODULE_ID__[1] + " " + nowParse__MODULE_ID__[2] + " " + nowParse__MODULE_ID__[3] + " " + nowParse__MODULE_ID__[4];
  var highlight;

  var eCount = eventA.length;  
  if (eCount > parseInt(max_display)) eCount = parseInt(max_display); // set max display

  evHTML = "<TABLE cellspacing=0 cellpadding=0 border=0 width='99%'>";

  for (var eI = 0; eI < eCount; eI++){
    event = eventA[eI];
   
    summary = event.title;
    summary = "<A class='gcalItem' href='" + event.URL  + "' target='_blank'>" + summary + "</A>";
    if (Dlocation) summary = summary + "<BR>" + event.location;

    std = dateParse__MODULE_ID__(event.startTS);
    etd = dateParse__MODULE_ID__(event.endTS);

    std['d'] = std[1] + " " + std[2] + " " + std[3] + " " + std[4];
    etd['d'] = etd[1] + " " + etd[2] + " " + etd[3] + " " + etd[4];

    if (now__MODULE_ID__ > new Date(std['d']) && Uhighlight){
      highlight = "GgcalItem__MODULE_ID__";
    } else if (now == std['d'] && Uhighlight){
      highlight = "HgcalItem__MODULE_ID__";
    } else highlight = "gcalItem__MODULE_ID__";

    var style = "valign=top class='" + highlight + "' style='font-size:" + displayFont + "pt'";

    // try to remove some of the dead space in the table
    std[1] = std[1] + "&nbsp;";
    std[2] = std[2] + "&nbsp;";
    std[4] = "&nbsp;" + std[4] + "&nbsp;";

    etd[1] = etd[1] + "&nbsp;";
    etd[2] = etd[2] + "&nbsp;";
    etd[4] = "&nbsp;" + etd[4] + "&nbsp;";

    if (!Dday_of_week){
      std[1] = "";
      etd[1] = "";
    }

    if (!Dmonth){
      std[2] = "";
      etd[2] = "";
    }

    if (!Ddate){
      std[3] = "";
      etd[3] = "";
    }

    if (!Dyear) {
      std[4] = "";
      etd[4] = "";
    }

    std['t'] = "";
    etd['t'] = "";
    if (Dtime){
      var AMPM = "a";
      if(std[5].substring(0,1) == "0") std[5] = std[5].substring(1,2);
      if(parseInt(std[5]) > 12){
        AMPM = "p";
        std[5] = parseInt(std[5]) - 12;
      } else if (parseInt(std[5]) == 0){
        AMPM = "a";
        std[5] = "12";
      } else if (parseInt(std[5]) == 12) AMPM = "p"; 

      std['t'] = std[5] + ":" + std[7] + AMPM;

      if(etd[5].substring(0,1) == "0") etd[5] = etd[5].substring(1,2);
      if(parseInt(etd[5]) > 12){
        AMPM = "p";
        etd[5] = parseInt(etd[5]) - 12;
      } else if (parseInt(etd[5]) == 0){
        AMPM = "a";
        etd[5] = "12";
      } else if (parseInt(etd[5]) == 12) AMPM = "p";

      etd['t'] = etd[5] + ":" + etd[7] + AMPM;
    }

    if (std['d'] != etd['d']){
      if (std['t'] == "12:00a" && etd['t'] == "12:00a"){
        std['t'] = "";
        etd['t'] = "";
      }

      if(Dsingle){
        // force single line format
        if (std[2] == etd[2]){
          if (etd[3] != "") std[3] = std[3] + "~" + etd[3];
        } else std[3] = std[3] + "~" + etd[2] + "&nbsp" + etd[3]

        if (etd['t'] != ""){
          std['t'] = std['t'] + "~" + etd['t'];
        }
      }

      evHTML += "<TR>" 
             + "<TD " +  style + ">" + std[1] + "</TD>" 
             + "<TD " +  style + ">" + std[2] + "</TD>" 
             + "<TD " +  style + ">" + std[3] + "</TD>" 
             + "<TD " +  style + ">" + std[4] + "</TD>" 
             + "<TD " +  style + ">" + std['t'] + "</TD>" 
             + "<TD " +  style + " rowspan=2>&nbsp;&nbsp;</TD>" 
             + "<TD " +  style + " rowspan=2 width='100%'>" + summary + "</TD></TR>";

      if (!Dsingle)
        evHTML += "<TR>" 
               + "<TD " +  style + ">" + etd[1] + "</TD>" 
               + "<TD " +  style + ">" + etd[2] + "</TD>" 
               + "<TD " +  style + ">" + etd[3] + "</TD>" 
               + "<TD " +  style + ">" + etd[4] + "</TD>" 
               + "<TD " +  style + ">" + etd['t'] + "</TD></TR>";

    }else{
      if (std['t'] != etd['t']) std['t'] = std['t'] + "~" + etd['t'];
      if (std['t'] == "12:00a") std['t'] = "";

      evHTML += "<TR>" 
             + "<TD " +  style + ">" + std[1] + "</TD>" 
             + "<TD " +  style + ">" + std[2] + "</TD>" 
             + "<TD " +  style + ">" + std[3] + "</TD>" 
             + "<TD " +  style + ">" + std[4] + "</TD>" 
             + "<TD " +  style + ">" + std['t'] + "</TD>" 
             + "<TD " +  style + ">&nbsp;&nbsp;</TD>"
             + "<TD width='100%' " +  style + ">" + summary + "</TD></TR>";
      
    }

    style = "valign=top class='" + highlight + "' style='font-size:2pt'";
    evHTML += "<TR><TD " +  style + " colspan=7>&nbsp;</TD></TR>";

  }

  evHTML += "</TABLE>";

  if (eCount == 0){
    calDIV.innerHTML = "<B>No Events Found.</B>";
  } else {
    evDIV = newNode__MODULE_ID__('div');
    evDIV.innerHTML = evHTML;
    calDIV.appendChild(evDIV);
  } 
 
  if (feed_url__MODULE_ID__.match(/.*basic$/)){
      _gel('status_content__MODULE_ID__').innerHTML = "<FONT style='color:red;font-size:.8em;'>Feed URL seems to be 'basic'.<BR>  Change to <A href='http://code.google.com/apis/gdata/calendar.html#Projection' target=_blank>'full'</A> for best results<FONT><BR><BR>";
  } else {
    _gel('status_content__MODULE_ID__').style.display = 'none';
    _gel('start_content__MODULE_ID__').style.display = 'none';
  }

  calDIV.style.display = '';


}

function cmp__MODULE_ID__(a,b) {
  return (a < b) ? -1 :( a > b) ? 1 : 0;
}

function shrink__MODULE_ID__(text,length,append){
  // shrinks text to length and makes undefined = ''
  // appends append to the end
  if (text){
    if (text.length > length) text = text.substring(0,length) + append; 
  } else text = "";

  return text;
}


function TSfromLocal__MODULE_ID__(string){
  var dRE = /([0-9]{4})([0-9]{2})([0-9]{2})/;
  var tRE = /T([0-9]{2})([0-9]{2})/;
  
  var date = dRE.exec(string);
  var time = tRE.exec(string);

  if (date) date = date[1] + "-" + date[2] + "-" + date[3];
  if (time) time = time[1] + ":" + time[2];

  return TSfromISO__MODULE_ID__(date + " " + time,0);
}

function TSfromString__MODULE_ID__(prefix,string,offset){
  // returns a TS from a google XML feed date time 
  var dtRE = new RegExp(prefix + "[\\s]+([^\\s]+)[\\s]([^\\s]+)");
  var dt = dtRE.exec(string);
  if (dt) {
    if (!dt[2].match(/[0-9]{2}:*./)) {
      // should add TZ offsetting RE to pass into TSfromISO
      dt[2] = "00:00";
      offset = 0;
    }
    dt = dt[1] + " " + dt[2]; 
  } else dt = "";

  return TSfromISO__MODULE_ID__(dt,offset); 

}

function TSfromISO__MODULE_ID__(ISO,offset){
  // converts date in the format 2006-04-15T20:00:00.000Z to milliseconds since EPOCH
  // works with 2006-04-15 20:00
  var tRE = /(\s|T)([0-9]{2}:[0-9]{2})/;
  var dRE = /([0-9]+)-([0-9]+)-([0-9]+)/;
  var oRE = /(\+|-){1}(.){5}$/;

  var TS;
  var date  = dRE.exec(ISO);
  var time  = tRE.exec(ISO);
  var gmtOffset = oRE.exec(ISO);

  var timeAdjust = false;

  if (date){
    if (time){
      time = time[2];
    } else {
      time = "00:00";
      gmtOffset = 0;
      timeAdjust = true;
    }

    if (gmtOffset){
      gmtOffset = gmtOffset[0];
      offset = 1;
    } else gmtOffset = 0; 
  
    if(date[2].substring(0,1) == "0") date[2] = date[2].substring(1,2);

    TS = new Date(monthA__MODULE_ID__[parseInt(date[2])] + " " + date[3] + " " + date[1] + " " + time);
 
// IF all day event get screwed up this is why
    var DSToffset = 0;
    if (timeAdjust){
      var TTS = TS;
      TS = new Date(TS.getTime() + 24 * 60 * 60 * 1000); // add a day
      DSToffset = (TS.getTimezoneOffset() - TTS.getTimezoneOffset()) * 1000 * 60;
      TS = new Date(TS.getTime() - DSToffset);
    } 


    TS = (offset == 0) ? TS.getTime() : TS.getTime() - (TS.getTimezoneOffset() * 60 * 1000) - (parseInt(gmtOffset) * 60 * 60 * 1000);

  } else TS = "";

  return TS;
}

function dateParse__MODULE_ID__(TS){
  var RE = /([^\s]+)[\s]([^\s]+)[\s]([^\s]+)[\s]([^\s]+)[\s]([^:]+)(:)([^:]+)/;
 
  var date = new Date(TS);
  if (IE__MODULE_ID__ == 1) {
    RE = /([^\s]+)[\s]([^\s]+)[\s]([^\s]+)[\s]([^:]+)(:)([^:]+):[^:]+[^\s]+[\s]([^\s]+)/;
    var parse = RE.exec(date.toString()); 
    parse[5] = parse[4];
    parse[4] = parse[7];
    parse[7] = parse[6];
    parse[6] = ":";
    return(parse);
  } else {
    return RE.exec(date.toString());
  }
}

function getObjMethodClosure__MODULE_ID__(object, method) {
  // shorthand object reference
  return function(arg) {
    return object[method](arg);
  }
}


</script>


<DIV id=about__MODULE_ID__>
<TABLE width=99% cellspacing=0 cellpadding=0 border=0><TR>

<TD style="text-decoration:none;color:gray;font-size:8pt" valign=bottom align=left width='50'>v0.1.14</TD>
<TD align=center valign=bottom align=center><SPAN id="date_content__MODULE_ID__" style="font-size:.85em;"></SPAN></TD>
<TD width='50' valign=bottom align=right><a target="_blank" style="text-decoration:none;color:gray;font-size:8pt" href="http://www.r2unit.com/gmodule/" target=_blank>about&nbsp;&gt;&gt;</a></TD>

</TR></TABLE>
</DIV>

<DIV id="status_content__MODULE_ID__" style="display:none;font-size:.85em;color:red">Loading Calendar...</DIV>
<DIV id="calendar_content__MODULE_ID__" style="display:none;font-size:.85em;overflow: auto;"></DIV>


<DIV id="start_content__MODULE_ID__" style="display:none;font-size:.85em;">
&nbsp;Getting Started:
    <ol>
      <li />Click "edit" next to the title above 
      <li />Set your preferences
      <li />Enter your <A href='http://www.google.com/support/calendar/bin/answer.py?answer=37648&topic=8566' target='_blank'>Google Calendar Feed URL</A> 
      <li />Feed URL works best as <A href='http://code.google.com/apis/gdata/calendar.html#Projection' target=_blank>'full'</A> which may not be available on shared Calendars.
      <li />Click save, calendar should load 
      <li />Stop missing your appointments
    </ol>
</DIV>


]]>
</Content>
</Module>


